name: Build and Deploy
on:
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Cache node modules
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 14 # Update to the desired Node.js version

      - name: Install Dependencies
        run: |
          npm ci
          npm install -g @angular/cli

      # ... Other steps ...

      - name: Set environment
        run: |
          VERSION=$(node -p "require('./package.json').version")
          BUILD_TIME=$(TZ=America/Los_Angeles date)
          sed -i "s/CI_COMMIT_SHORT_SHA/${GITHUB_SHA:0:8}/" src/environments/*.ts
          sed -i "s/CI_PIPELINE_ID/$GITHUB_RUN_ID/" src/environments/*.ts
          sed -i "s/BUILD_TIME/$BUILD_TIME/" src/environments/*.ts
          sed -i "s/VERSION/$VERSION/" src/environments/*.ts

      - name: Build
        run:  npm run build:prod

      - name: checking environment variables
        run: |
          printenv
          cat src/environments/*.ts
          ls -R

      # ... Other steps ...

      # - name: Deploy ðŸš€
      #   uses: JamesIves/github-pages-deploy-action@releases/v3
      #   with:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     base_href: /
      #     build_configuration: production
      #     BRANCH: gh-pages # The branch the action should deploy to.
      #     FOLDER: dist # The folder the action should deploy.

      - name: Angular Deploy gh-pages Actions
        # You may pin to the exact commit or the version.
        # uses: AhsanAyaz/angular-deploy-gh-pages-actions@2272ef32f364bc80d8680ee03d8e58f126156c31
        uses: AhsanAyaz/angular-deploy-gh-pages-actions@v1.4.0
        with:
          # Github access token token used to deploy on gh_pages. You can find it on Github.
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          # The directory of the angular project, in which all the commands will run
          # angular_project_dir: dist # optional, default is ./
          # Build configuration for the angular app
          # build_configuration: production # optional, default is production
          # base href for the app
          # base_href: / # optional, default is /
          # branch on which the angular build will be deployed
          # deploy_branch: # optional, default is gh-pages
          # The folder in which `ng build` provides its output. This is the folder which will be deployed to the `deploy_branch`.
          # angular_dist_build_folder: # optional, default is dist
          # If the action should run 'ng lint'
          # run_lint: # optional
          # Will not fail the step if anything fails
          # skip_failure: # optional